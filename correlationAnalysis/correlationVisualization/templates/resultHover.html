{% load static %}
{% load tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
  <head>
    {% tailwind_css %}
    <meta charset="UTF-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <title>Correlation Analysis</title>

    <link
    href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp"
    rel="stylesheet"
    />
  </head>
  <body class="h-100 text-center text-black bg-white">
    <h1 class="text-4xl m-4 items-center">Correlation Analysis Result</h1>
    <h2 class="text-2xl m-2 items-center">Heatmap of correlation between types of data uses and data types</h1>
    <h2 class="text-xl m-2 items-center">Domain: {{ domain }}</h1>
    <h2 class="text-xl m-2 items-center">Sample Size: {{ sampleSize }}</h1>

<!-- https://www.d3-graph-gallery.com/graph/heatmap_tooltip.html -->
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<h3>Feel free to hover over the heatmap and the axes for more details</h3>
<!-- Create a div where the graph will take place -->
<div id="heatmap" class="flex items-center justify-center bg-white rounded-md py-10 px-12 shadow-lg">
</div>
<script>

// set the dimensions and margins of the graph
var margin = {top: 10, right: 10, bottom: 200, left: 200},
  width = 800 - margin.left - margin.right,
  height = 750 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#heatmap")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

// Labels of row and columns
var labels = ["Observational/Empirical (Type)", "Experimental (Type)", "Simulation (Type)", "Derived/Compiled (Type)", "Other Types", "Basis for new study", "Calibration", "Benchmarking", "Verification", "Input", "Generating new ideas", "Teaching", "Prepare new project/proposal", "Experimental Use", "Identifying trends/predictions", "Comparison", "Summarizations", "Integrate with other data", "Other Uses"]
labels = labels.reverse()
var axisDescriptions = {"Observational/Empirical (Type)":"Observational or empirical data types", "Experimental (Type)":"Experimental data types", "Simulation (Type)":"Simulation data types", "Derived/Compiled (Type)":"Derived or compiled data type", "Other Types":"Other data types", "Basis for new study":"Use data as the basis for a new study",
                        "Calibration":"Use data to calibrate instruments or models", "Benchmarking":"Use data for benchmarking", "Verification":"Use data to verify own data", "Input":"Use data as model, algorithm or system inputs","Generating new ideas":"Use data to generate new ideas",
                        "Teaching":"Use data for teaching/training", "Prepare new project/proposal":"Use data to prepare for new project or proposal", "Experimental Use":"Use data to experiment with new methods and techniques", "Identifying trends/predictions":"Use data to identify trends, make predictions",
                        "Comparison":"Use data to compare multiple datasets", "Summarizations":"Use data to create summaries, visualizations, analysis tools", "Integrate with other data":"Use data to integrate with other data", "Other Uses":"Use data for other uses"};
//axisDescriptions = axisDescriptions.reverse()

// create a tooltip
var tooltip = d3.select("#heatmap")
  .append("div")
  .style("position", "absolute")
  .style("opacity", 0)
  .attr("class", "tooltip")
  .style("background-color", "white")
  //.style("border", "solid")
  .style("border-width", "2px")
  //.style("border-radius", "2px")
  .style("padding", "5px")



// Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    tooltip.style("opacity", 1)
  }

  var mousemove = function(d) {
    tooltip
      .html(d.Group1 + " - " + d.Group2 + ": " + d.Value)
      .style("left", (d3.event.x+10) + "px")
      .style("top", (d3.event.y+10) + "px")
  }
  var mouseleave = function(d) {
    tooltip.style("opacity", 0)
  }



// Build X scales and axis:
var xAxis = d3.scaleBand()
  .range([ 0, width ])
  //.domain(axisDescriptions.map(function(d) { return d.key}))
  .domain(labels)
  .padding(0.01);

svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(xAxis))
  .selectAll("text")  
  .style("text-anchor", "end")
  .style("font-size", 13)
  .attr("dx", "-.8em")
  .attr("dy", ".15em")
  .attr("transform", "rotate(-65)");

// Build Y scales and axis:
var yAxis = d3.scaleBand()
  .range([ height, 0 ])
  //.domain(axisDescriptions.map(function(d) { return d.key}))
  .domain(labels)
  .padding(0.01);

ax = svg.append("g")
  .attr("class", "yAxis")
  .call(d3.axisLeft(yAxis))
  .selectAll("text")  
  .style("text-anchor", "end")
  .style("font-size", 13)
  .attr("dx", "-.8em")
  .attr("dy", ".15em")

d3.selectAll(".tick>text")
.on("mousemove", mouseover)
.on("mouseover", function(t) {
    tooltip
      .html(axisDescriptions[this.innerHTML])
      .style("left", (d3.event.x+10) + "px")
      .style("top", (d3.event.y+10) + "px")
      .style("position", "absolute")
  })
.on("mouseleave", mouseleave) 


// Build color scale
var myColor = d3.scaleLinear()
  .range(["white", "#3b82f6"])
  .domain([0,1])

//Read the data
d3.csv("{% static '/correlationVisualization/files/correlations.csv' %}", function(data) {

  // add the squares
  svg.selectAll()
    .data(data, function(d) {return d.Group1+':'+d.Group2;})
    .enter()
    .append("rect")
      .attr("x", function(d) { return xAxis(d.Group1) })
      .attr("y", function(d) { return yAxis(d.Group2) })
      .attr("width", xAxis.bandwidth() )
      .attr("height", yAxis.bandwidth() )
      .style("fill", function(d) { return myColor(d.Value)} )
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave)
})

</script>

    <div class="flex items-center justify-center mt-8 bg-white rounded-md py-10 px-12 shadow-lg">
        <div class="col-span-12">
          <h2 class="text-2xl m-2 items-center">Top correlations</h2>

          <table class="table text-gray-400 space-y-6 text-sm m-12">
            <thead class="bg-blue-500 text-white mb-12">
              <tr>
                <th class="p-3">Corr Value</th>
                <th class="p-3">Interpretation</th>
              </tr>
            </thead>
            <tbody>
              <tr class="bg-blue-200 lg:text-black">
                <td class="p-3 font-medium capitalize">0 - 0.29</td>
                <td class="p-3 font-medium capitalize">No correlation</td>
              </tr>
              <tr class="bg-blue-200 lg:text-black">
                <td class="p-3 font-medium capitalize">0.3 - 0.49</td>
                <td class="p-3 font-medium capitalize">Weak correlation</td>
              </tr>
              <tr class="bg-blue-200 lg:text-black">
                <td class="p-3 font-medium capitalize">0.5 - 0.69</td>
                <td class="p-3 font-medium capitalize">Moderate correlation</td>
              </tr>
              <tr class="bg-blue-200 lg:text-black">
                <td class="p-3 font-medium capitalize">0.7 - 0.89</td>
                <td class="p-3 font-medium capitalize">High correlation</td>
              </tr>
              <tr class="bg-blue-200 lg:text-black">
                <td class="p-3 font-medium capitalize">0.9 - 1</td>
                <td class="p-3 font-medium capitalize">Very high correlation</td>
              </tr>
            </tbody>
          </table>
            <table class="table text-gray-400 space-y-6 text-sm m-12">
              <thead class="bg-blue-500 text-white mb-12">
                <tr>
                  <th class="p-3">Variables</th>
                  <th class="p-3">Value</th>
                </tr>
              </thead>
              <tbody>
                {% for keys, value in res.items %}
                <tr class="bg-blue-200 lg:text-black">
                    <td class="p-3 font-medium capitalize">
                    {% for key in keys %}
                        {{ key }} </br>
                    {% endfor %}
                    </td>
                    <td class="p-3">{{ value }}</td>
                </tr>
                {% endfor %}
               </tbody>
            </table>
          </div>
        </div>
    

  </body>
</html>
